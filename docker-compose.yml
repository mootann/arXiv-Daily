services:
  # PostgreSQL数据库服务
  postgres:
    image: pgvector/pgvector:pg16
    container_name: arxiv-daily-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: arXiv-Daily
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 123456
      TZ: Asia/Shanghai
    ports:
      - "15432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - arxiv-daily-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d arXiv-Daily"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis缓存服务
  redis:
    image: redis:7-alpine
    container_name: arxiv-daily-redis
    restart: unless-stopped
    command: redis-server --requirepass 123456 --appendonly yes
    ports:
      - "16379:6379"
    volumes:
      - redis_data:/data
    networks:
      - arxiv-daily-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # Zookeeper服务（Kafka依赖）
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0
    container_name: arxiv-daily-zookeeper
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: 12181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_MAX_CLIENT_CNXNS: 0
    ports:
      - "12181:12181"
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_logs:/var/lib/zookeeper/log
    networks:
      - arxiv-daily-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "12181"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  # Kafka消息队列服务
  kafka:
    image: confluentinc/cp-kafka:7.6.0
    container_name: arxiv-daily-kafka
    restart: unless-stopped
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:12181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:19092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
      KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS: 300000
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      TZ: Asia/Shanghai
    ports:
      - "9092:9092"
      - "19092:19092"
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - arxiv-daily-network
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server kafka:9092"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 120s

  # MinIO对象存储服务
  minio:
    image: minio/minio:latest
    container_name: arxiv-daily-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      TZ: Asia/Shanghai
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - arxiv-daily-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # MinIO客户端（用于初始化存储桶）
  minio-init:
    image: minio/mc:latest
    container_name: arxiv-daily-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint:
      - /bin/sh
      - -c
      - |
        until mc alias set minio http://minio:9000 minioadmin minioadmin; do
          echo "等待MinIO服务启动..."
          sleep 3
        done
        if mc ls minio/arxiv-daily > /dev/null 2>&1; then
          echo "存储桶已存在，删除旧存储桶"
          mc rb minio/arxiv-daily --force
        fi
        echo "创建存储桶: arxiv-daily"
        mc mb minio/arxiv-daily
        echo "存储桶创建成功"
        mc anonymous set download minio/arxiv-daily
        echo "存储桶权限设置为公开下载"
        echo "MinIO初始化完成"
    networks:
      - arxiv-daily-network

  # Kafka主题初始化（用于创建Kafka主题）
  kafka-init:
    image: confluentinc/cp-kafka:7.6.0
    container_name: arxiv-daily-kafka-init
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint:
      - /bin/sh
      - -c
      - |
        until kafka-topics --bootstrap-server kafka:9092 --list; do
          echo "等待Kafka服务启动..."
          sleep 3
        done
        if ! kafka-topics --bootstrap-server kafka:9092 --list | grep -q "^parse-topic$$"; then
          echo "创建主题: parse-topic"
          kafka-topics --create --bootstrap-server kafka:9092 --topic parse-topic --partitions 3 --replication-factor 1
          echo "主题创建成功"
        else
          echo "主题已存在"
        fi
        echo "Kafka初始化完成"
    networks:
      - arxiv-daily-network

networks:
  arxiv-daily-network:
    driver: bridge
    name: arxiv-daily-network

volumes:
  postgres_data:
    name: arxiv-daily-postgres-data
  redis_data:
    name: arxiv-daily-redis-data
  zookeeper_data:
    name: arxiv-daily-zookeeper-data
  zookeeper_logs:
    name: arxiv-daily-zookeeper-logs
  kafka_data:
    name: arxiv-daily-kafka-data
  minio_data:
    name: arxiv-daily-minio-data
